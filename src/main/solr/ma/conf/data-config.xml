<dataConfig>

	<dataSource name="komp2db" jndiName="java:comp/env/jdbc/komp2DataSource" />
    <dataSource name="ontodb" jndiName="java:comp/env/jdbc/ontodbDataSource" />  
	<dataSource name="allele_core" type="HttpDataSource" baseUrl="http://ves-ebi-d0.ebi.ac.uk:8090/build_indexes/allele/select?" encoding="UTF-8"  connectionTimeout="10000" readTimeout="10000"/>
    <dataSource name="images_core" type="HttpDataSource" baseUrl="http://ves-ebi-d0.ebi.ac.uk:8090/build_indexes/images/select?" encoding="UTF-8"  connectionTimeout="10000" readTimeout="10000"/>          

	<document name="komp2_indexing">	
		<!-- test with MA:0001459 -->
		<!-- IMPC pipeline -->							
        <!-- MA term has no definition -->
		<!-- selected MA top levels: 'MA:0000009','MA:0000020','MA:0002450','MA:0000010', 'MA:0002506','MA:0002431','MA:0000012','MA:0002411','MA:0000007','MA:0002711','MA:0000014','MA:0002418','MA:0000016','MA:0000325','MA:0000326','MA:0000327','MA:0000004' -->
        <entity dataSource="ontodb" name="ma_term_infos" query="select 'ma' as dataType, term_id, name from ma_term_infos where term_id != 'MA:0000001'" >			

     		<field column="dataType" name="dataType" />	
			<field column="term_id" name="ma_id" />
            <field column="name" name="ma_term" /> 

            <!-- subset of this MA term: parsed from obo file -->
			<entity dataSource="ontodb" name="ma_term_subsets"
				query="select subset from ma_term_subsets where term_id='${ma_term_infos.term_id}'">
				<field column="subset" name= "ontology_subset" />
			</entity>

            <!-- MA term name synonym -->
			<entity dataSource="ontodb" name="ma_synonyms" query="select syn_name from ma_synonyms where term_id = '${ma_term_infos.term_id}'" >				
				<field column="syn_name" name="ma_term_synonym" />
            </entity>

            <!-- MA to MP mapping based on MP to MA bridg file prepared by Terry with MP slim -->
            <entity dataSource="ontodb" name="mp_mappings" query="select term_id from mp_mappings where mapped_term_id = '${ma_term_infos.term_id}'" >	 

                <field column="term_id" name="inferred_mp_id" /> 				
			
				<entity dataSource="ontodb" name="mp_mappings2" query="select * from mp_term_infos where term_id = '${mp_mappings.term_id}'">
					<field column="name" name="inferred_mp_term" />
					<field column="definition" name="inferred_mp_definition" />
				</entity>

				<!-- top level MP term of this MP term -->
				<entity dataSource="ontodb" name="mp_node2term"
					query="select distinct node_id from mp_node2term where term_id='${mp_mappings.term_id}'">
					<entity dataSource="ontodb" name="mp_node_top_level"
						query="select distinct top_level_node_id from mp_node_top_level where node_id=${mp_node2term.node_id}">
						<entity dataSource="ontodb" name="mp_node2term2"
							query="select distinct term_id from mp_node2term where node_id=${mp_node_top_level.top_level_node_id}">
							<entity dataSource="ontodb" name="mp_term_infos2"							
								query="select term_id, name, definition from mp_term_infos where term_id='${mp_node2term2.term_id}' and term_id != 'MP:0000001'" >
								<!-- do not want to include the root term -->
								<field column="term_id" name="inferred_top_level_mp_id" />
								<field column="name" name="inferred_top_level_mp_term" />
								<field column="definition" name="inferred_top_level_mp_definition" />														
		                      
							</entity>
						</entity>
					</entity>
				</entity>

				<!-- MGI genes annotated to this MA through this MP term -->
				<!-- p_value applied -->
				<entity dataSource="komp2db" name="phenotype_call_summary"
					query="select distinct gf_acc, procedure_id, parameter_id, pipeline_id, allele_acc, strain_acc, p_value from phenotype_call_summary where mp_acc='${mp_mappings.term_id}' and p_value &lt;= 0.0001 and gf_db_id=3 and gf_acc like 'MGI:%' and allele_acc is not null and strain_acc is not null">											
				
					<field column="gf_acc" name="mgi_accession_id" />				
					
					<!-- disease associated with this MP via this gene -->	
					<entity dataSource="allele_core" name="gdoc" stream="true" url="q=mgi_accession_id:&quot;${phenotype_call_summary.gf_acc}&quot;&amp;rows=1&amp;wt=normal"
					
						processor="XPathEntityProcessor" forEach="/response/result/doc/" >						
						
						<!--  do not want to infer disease for MA                                    
					    <field column="disease_source" xpath="/response/result/doc/arr[@name='disease_source']/str" /> 
					    <field column="disease_term" xpath="/response/result/doc/str[@name='disease_term']" /> 
					    <field column="disease_alts" xpath="/response/result/doc/arr[@name='disease_alts']/str" /> 
					    <field column="disease_classes" xpath="/response/result/doc/arr[@name='disease_classes']/str" /> 
					    <field column="human_curated" xpath="/response/result/doc/bool[@name='human_curated']" /> 
					    <field column="mouse_curated" xpath="/response/result/doc/bool[@name='mouse_curated']" /> 
					    <field column="mgi_predicted" xpath="/response/result/doc/bool[@name='mgi_predicted']" /> 
					    <field column="impc_predicted" xpath="/response/result/doc/bool[@name='impc_predicted']" /> 
					    <field column="mgi_predicted_in_locus" xpath="/response/result/doc/bool[@name='mgi_predicted_in_locus']" /> 
					    <field column="impc_predicted_in_locus" xpath="/response/result/doc/bool[@name='impc_predicted_in_locus']" /> 			
						<field column="disease_human_phenotypes" xpath="/response/result/doc/arr[@name='phenotypes']/str" />  					
						-->
						<!-- other gene related fields -->						
						<field column="marker_symbol" xpath="/response/result/doc/str[@name='marker_symbol']" />                                                        
	                    <field column="marker_name" xpath="/response/result/doc/str[@name='marker_name']" />
	                    <field column="marker_synonym" xpath="/response/result/doc/arr[@name='marker_synonym']/str" />
	                    <field column="marker_type" xpath="/response/result/doc/str[@name='marker_type']" />                                     
	                    <field column="human_gene_symbol" xpath="/response/result/doc/arr[@name='human_gene_symbol']/str" />
	                             
	                    <!-- latest project status (ES cells/mice production status) -->         
	                    <field column="status" xpath="/response/result/doc/str[@name='status']" />
	                    
	                    <!-- latest mice phenotyping status for faceting -->
	                    <field column="imits_phenotype_started" xpath="/response/result/doc/str[@name='imits_phenotype_started']" />        
	                    <field column="imits_phenotype_complete" xpath="/response/result/doc/str[@name='imits_phenotype_complete']" />
	                  	<field column="imits_phenotype_status" xpath="/response/result/doc/str[@name='imits_phenotype_status']" />
	                  
	                  	<!-- production/phenotyping centers -->
						<field column="latest_production_centre" xpath="/response/result/doc/arr[@name='latest_production_centre']/str" />
						<field column="latest_phenotyping_centre" xpath="/response/result/doc/arr[@name='latest_phenotyping_centre']/str" />
							
						<!-- alleles of a gene -->
						<field column="allele_name" xpath="/response/result/doc/arr[@name='allele_name']/str" />		
		
					</entity>											
				</entity>
				
				<!-- pipeline/procedure and allele/strain annotated to this MA through this MP term -->
				<!-- no p_value applied -->
				<entity dataSource="komp2db" name="phenotype_call_summary"
					query="select distinct gf_acc, procedure_id, parameter_id, pipeline_id, allele_acc, strain_acc from phenotype_call_summary where mp_acc='${mp_mappings.term_id}' and gf_db_id=3 and gf_acc like 'MGI:%' and allele_acc is not null and strain_acc is not null">											
																		
					<!-- allele: currently NOT restricted to MGI alleles, ie, allele_db_id not restricted to 3 -->
					<!-- index will be problematic if phenotype_call_summary.allele_acc and phenotype_call_summary.gf_acc do not have an entry in komp2.allele table -->
					<entity dataSource="komp2db" name="allele"
						query="select distinct symbol, acc from allele where acc='${phenotype_call_summary.allele_acc}' and gf_acc='${phenotype_call_summary.gf_acc}'">
						<field column="symbol" name="allele_symbol" />
						<field column="acc" name="allele_id" />
					</entity>

					<!-- strain -->
					<entity dataSource="komp2db" name="strain"
						query="select distinct name, acc from strain where acc='${phenotype_call_summary.strain_acc}' and db_id=3">
						<field column="name" name="strain_name" />
						<field column="acc" name="strain_id" />
					</entity>

					<!-- pipeline -->
					<entity dataSource="komp2db" name="phenotype_pipeline"
						query="select distinct stable_id, name, stable_key from phenotype_pipeline where id=${phenotype_call_summary.pipeline_id}">
						<field column="stable_id" name="pipeline_stable_id" />
						<field column="name" name="pipeline_name" />
						<field column="stable_key" name="pipeline_stable_key" />
					</entity>

					<!-- procedure of pipeline -->
					<entity dataSource="komp2db" name="phenotype_procedure"
						query="select distinct name, stable_id, stable_key from phenotype_procedure where id = ${phenotype_call_summary.procedure_id}">
						<field column="name" name="procedure_name" />
						<field column="stable_id" name="procedure_stable_id" />
						<field column="stable_key" name="procedure_stable_key" />
					</entity>

					<!-- parameter of pipeline -->
					<entity dataSource="komp2db" name="phenotype_parameter"
						query="select distinct name, stable_id, stable_key from phenotype_parameter where id=${phenotype_call_summary.parameter_id}">
						<field column="name" name="parameter_name" />
						<field column="stable_id" name="parameter_stable_id" />
						<field column="stable_key" name="parameter_stable_key" />
					</entity>
				</entity>
				
            </entity>
 			
            <entity dataSource="ontodb" name="ma_node2term"
            	query="select node_id from ma_node2term where term_id='${ma_term_infos.term_id}'">

                <!-- child MA term(s) of this MA term -->
                <entity dataSource="ontodb" name="ma_parent_children" onError="continue"
                	query="select child_node_id from ma_parent_children where parent_node_id=${ma_node2term.node_id}">                    
                    <entity dataSource="ontodb" name="ma_node2term2"
                    	query="select term_id from ma_node2term where node_id=${ma_parent_children.child_node_id}">                                                     
                        <entity dataSource="ontodb" name="ma_term_infos2"
                           	query="select term_id, name, concat(term_id, '__', name) as termId_termName from ma_term_infos where term_id='${ma_node2term2.term_id}'">
                            <field column="term_id" name="child_ma_id" />
                            <field column="name" name="child_ma_term" />  
                            <field column="termId_termName" name="child_ma_idTerm" />                    
                     	</entity>
                  	</entity>
            	</entity>

                <!-- higher level backtrace of this MA term -->           
                <entity dataSource="ontodb" name="ma_node_2_selected_top_level_mapping" 
                    query="select top_level_term_id from ma_node_2_selected_top_level_mapping where node_id = ${ma_node2term.node_id}" >
                    <field column="top_level_term_id" name="selected_top_level_ma_id" />
                    <entity dataSource="ontodb" name="ma_term_infos2" query="select name from ma_term_infos where term_id = '${ma_node_2_selected_top_level_mapping.top_level_term_id}' " >
                        <field column="name" name="selected_top_level_ma_term" />
                    </entity>
                </entity>
      		</entity>          
			
			<!-- images annotated to this MA -->
			<entity dataSource="images_core" name="imgCore" stream="true" url="q=maTermId:&quot;${ma_term_infos.term_id}&quot;&amp;wt=normal&amp;rows=999999"
				processor="XPathEntityProcessor" forEach="/response/result/doc/"							
				readTimeout="10000" connectionTimeout="10000"  >
			
				<field column="largeThumbnailFilePath" xpath="/response/result/doc/str[@name='largeThumbnailFilePath']"/>
				<field column="smallThumbnailFilePath" xpath="/response/result/doc/str[@name='smallThumbnailFilePath']"/>
				<field column="expName" xpath="/response/result/doc/arr[@name='expName']/str"/>
				<field column="expName_exp" xpath="/response/result/doc/arr[@name='expName_exp']/str" />
				<field column="symbol_gene" xpath="/response/result/doc/arr[@name='symbol_gene']/str" />
				<field column="inferredHigherLevelMpTermId" xpath="/response/result/doc/arr[@name='inferredHigherLevelMpTermId']/str" />
				<field column="inferredHigherLevelMpTermName" xpath="/response/result/doc/arr[@name='inferredHigherLevelMpTermName']/str" />	
				<field column="annotationTermName" xpath="/response/result/doc/arr[@name='annotationTermName']/str" />
				<field column="annotationTermId" xpath="/response/result/doc/arr[@name='annotationTermId']/str" />			
				<field column="maTermId" xpath="/response/result/doc/arr[@name='mpTermId']/str" />
				<field column="maTermName" xpath="/response/result/doc/arr[@name='mpTermName']/str" />
				<field column="annotatedHigherLevelMaTermName" xpath="/response/result/doc/arr[@name='annotatedHigherLevelMaTermName']/str" />				
			</entity>

             <!-- top level term and/or top level term from part_of relationship of a given anatomy term id -->
			<entity  dataSource="ontodb" name="ma_node2term" onError="continue" 
                query="select node_id from ma_node2term where term_id='${ma_term_infos.term_id}'" >				
				<entity  dataSource="ontodb" name="ma_node_top_level" onError="continue" 
                    query="select top_level_node_id from ma_node_top_level where node_id=${ma_node2term.node_id}" >
					<entity  dataSource="ontodb" name="ma_node2term" onError="continue"
                        query="select term_id from ma_node2term where node_id=${ma_node_top_level.top_level_node_id}" >					
                        <entity  dataSource="ontodb" name="ma_term_infos" 
                            query="select term_id, name from ma_term_infos where term_id='${ma_node2term.term_id}'" >
							<field column="term_id" name="top_level_ma_id" />
           					<field column="name" name="top_level_ma_term" />            				
						</entity>
					</entity>
					<!-- continue with null value for top_level_id from part_of relationship 
					<entity  dataSource="ontodb" name="ma_node_top_level_part_of"  onError="continue" 
                        query="select top_level_node_id from ma_node_top_level_part_of where node_id=${ma_node_top_level.node_id}" >
						<entity  dataSource="ontodb" name="ma_node2term" onError="continue"
                            query="select term_id from ma_node2term where node_id=${ma_node_top_level_part_of.top_level_node_id}" >				
                        	<entity  dataSource="ontodb" name="ma_term_infos" onError="continue"
                                query="select term_id, name from ma_term_infos where term_id='${ma_node2term.term_id}'" >
								<field column="term_id" name="top_level_ma_id_part_of" />
           						<field column="name" name="top_level_ma_term_part_of" />            					
							</entity>
						</entity>
					</entity>-->
				</entity>			
			</entity>
		</entity>	
	</document>

</dataConfig>
	