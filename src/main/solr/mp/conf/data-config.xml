     
<dataConfig>
	
	<dataSource name="komp2db" jndiName="java:comp/env/jdbc/komp2DataSource" />
	<dataSource name="ontodb" jndiName="java:comp/env/jdbc/ontodbDataSource" /> 
	<dataSource name="diseaseGenedb" jndiName="java:comp/env/jdbc/diseaseGeneDataSource" />  
	<dataSource name="allele_core" type="HttpDataSource" baseUrl="http://ves-ebi-d0.ebi.ac.uk:8090/build_indexes/allele/select?" encoding="UTF-8"  connectionTimeout="10000" readTimeout="10000"/>	  
	<dataSource name="images_core" type="HttpDataSource" baseUrl="http://ves-ebi-d0.ebi.ac.uk:8090/build_indexes/images/select?" encoding="UTF-8"  connectionTimeout="10000" readTimeout="10000"/>       
	
	<document name="docs">
		<!-- test with MP:0002100, MP:0002075-->
		<!-- term infos: ID, name, definition -->

		<entity dataSource="ontodb" name="mp_term_infos"			
			query="select 'mp' as dataType, term_id, name, definition from mp_term_infos where term_id !='MP:0000001'">

			<field column="dataType" name="dataType"/>
			<field column="term_id" name="mp_id" />
			<field column="name" name="mp_term" />
			<field column="definition" name="mp_definition" />		

			<!-- images annotated to this MP -->
			<entity dataSource="images_core" name="imgCore" stream="true" url="q=mpTermId:&quot;${mp_term_infos.term_id}&quot;&amp;wt=normal&amp;rows=999999"
				processor="XPathEntityProcessor" forEach="/response/result/doc/"							
				readTimeout="10000" connectionTimeout="10000"  >
			
				<field column="largeThumbnailFilePath" xpath="/response/result/doc/str[@name='largeThumbnailFilePath']"/>
				<field column="smallThumbnailFilePath" xpath="/response/result/doc/str[@name='smallThumbnailFilePath']"/>
				<field column="expName" xpath="/response/result/doc/arr[@name='expName']/str"/>
				<field column="expName_exp" xpath="/response/result/doc/arr[@name='expName_exp']/str" />
                <field column="subtype" xpath="/response/result/doc/arr[@name='subtype']/str" />
				<field column="symbol_gene" xpath="/response/result/doc/arr[@name='symbol_gene']/str" />
				<field column="inferredHigherLevelMaTermId" xpath="/response/result/doc/arr[@name='inferredHigherLevelMaTermId']/str" />
				<field column="inferredHigherLevelMaTermName" xpath="/response/result/doc/arr[@name='inferredHigherLevelMaTermName']/str" />	
				<field column="annotationTermName" xpath="/response/result/doc/arr[@name='annotationTermName']/str" />
				<field column="annotationTermId" xpath="/response/result/doc/arr[@name='annotationTermId']/str" />			
				<field column="mpTermId" xpath="/response/result/doc/arr[@name='mpTermId']/str" />
				<field column="mpTermName" xpath="/response/result/doc/arr[@name='mpTermName']/str" />
				<field column="annotatedHigherLevelMpTermName" xpath="/response/result/doc/arr[@name='annotatedHigherLevelMpTermName']/str" />
			</entity>

			<!-- subset of this MP term: parsed from obo file -->
			<entity dataSource="ontodb" name="mp_term_subsets"
				query="select subset from mp_term_subsets where term_id='${mp_term_infos.term_id}'">
				<field column="subset" name="ontology_subset" />
			</entity>

			<!-- synonym of this MP term -->
			<entity dataSource="ontodb" name="mp_synonyms"
				query="select distinct syn_name from mp_synonyms where term_id = '${mp_term_infos.term_id}'">
				<field column="syn_name" name="mp_term_synonym" />
			</entity>

			<!-- GO association of MP term -->
			<entity dataSource="ontodb" name="mp_dbxrefs"
				query="select distinct xref_id from mp_dbxrefs where term_id='${mp_term_infos.term_id}' and xref_id like 'GO:%'">
				<field column="xref_id" name="go_id" />
			</entity>				

			<!-- top level MP term of this MP term -->						
			<entity dataSource="ontodb" name="mp_node2term"
				query="select tl.top_level_node_id from mp_node_top_level tl, mp_node2term nt, mp_term_infos ti where ti.term_id='${mp_term_infos.term_id}' and ti.term_id=nt.term_id and nt.node_id=tl.node_id">
				<entity dataSource="ontodb" name="toplevel" 
					query="select ti.*, concat(ti.name, '___', ti.term_id) as top_level_mp_term_id from mp_node2term nt, mp_term_infos ti where nt.term_id=ti.term_id and nt.node_id=${mp_node2term.top_level_node_id}"
					>

						<field column="term_id" name="top_level_mp_id" />
						<field column="name" name="top_level_mp_term" />
						<field column="definition" name="top_level_mp_definition" />	
						<field column="top_level_mp_term_Id" name ="top_level_mp_term_Id" />
						
						<entity dataSource="ontodb" name="mp_term_infos2Syn" onError="continue"  
							query="select * from mp_synonyms where term_id ='${toplevel.term_id}'">						
							<field column="syn_name" name="top_level_mp_term_synonym" />
						</entity>						

				</entity>
			</entity>
			
			<!-- intermediate MP terms of this MP term -->
			<entity dataSource="ontodb" name="parents" onError="continue" 
				query="select f.node_id as parent_node_id from mp_node2term nt, mp_node_subsumption_fullpath f where nt.node_id=f.child_node_id and nt.term_id='${mp_term_infos.term_id}' and f.node_id != nt.node_id" >
			
				<entity dataSource="ontodb" name="parents2" onError="continue"  
					query="select ti.* from mp_term_infos ti, mp_node2term nt where ti.term_id=nt.term_id and nt.node_id=${parents.parent_node_id}">
					
					<field column="term_id" name="intermediate_mp_id" />
					<field column="name" name="intermediate_mp_term" />
					<field column="definition" name="intermediate_mp_definition" />				
					
					<entity dataSource="ontodb" name="parents2Syn" onError="continue"  
						query="select * from mp_synonyms where term_id ='${parents2.term_id}'">
						
						<field column="syn_name" name="intermediate_mp_term_synonym" />						
					
					</entity>
					
				</entity>;
			</entity>		

			<!-- child MP term of this MP term -->
			<entity dataSource="ontodb" name="mp_node2term3"
				query="select distinct node_id from mp_node2term where term_id='${mp_term_infos.term_id}'">
				<entity dataSource="ontodb" name="mp_parent_children" onError="continue"
					query="select distinct child_node_id from mp_parent_children where parent_node_id=${mp_node2term3.node_id}">
					
					<entity dataSource="ontodb" name="mp_node2term4"
						query="select distinct term_id from mp_node2term where node_id=${mp_parent_children.child_node_id}">

						<!-- only index child term that has mp annotation -->
						<entity dataSource="komp2db" onError="continue" name="phenotype_call_summary"
							query="select count(*) from phenotype_call_summary where mp_acc='${mp_node2term4.term_id}'">
							<entity dataSource="ontodb" name="mp_term_infos3"
								query="select distinct term_id, name, definition from mp_term_infos where term_id='${mp_node2term4.term_id}'">
								<field column="term_id" name="child_mp_id" />
								<field column="name" name="child_mp_term" />
								<field column="definition" name="child_mp_definition" />
							</entity>
							<entity dataSource="ontodb" name="parents2Syn" onError="continue"  
								query="select * from mp_synonyms where term_id ='${mp_term_infos3.term_id}'">
						
								<field column="syn_name" name="child_mp_term_synonym" />						
					
							</entity>

						</entity>					
					</entity>
				</entity>
			</entity>

			<!-- MP -> MA relationship; MA term has no definition -->
			<entity dataSource="ontodb" name="mp_mappings" onError="continue"
				query="select distinct mapped_term_id from mp_mappings where term_id='${mp_term_infos.term_id}' and ontology='MA'">
				<field column="mapped_term_id" name="ma_id" />
				<field column="mapped_term_id" name="inferred_ma_id" />
				<entity dataSource="ontodb" name="ma_term_infos"
					query="select name from ma_term_infos where term_id='${mp_mappings.mapped_term_id}'">
					<field column="name" name="ma_term" />
					<field column="name" name="inferred_ma_term" />
				</entity>
				
				<!-- selected higher level backtrace of this MA term -->           
				<entity dataSource="ontodb" name="ma_node_2_selected_top_level_mapping" 
					query="select distinct ti.term_id, ti.name  from ma_node2term nt, ma_node_2_selected_top_level_mapping m, ma_term_infos ti where nt.node_id=m.node_id and m.top_level_term_id=ti.term_id and nt.term_id='${mp_mappings.mapped_term_id}'">;
					<field column="term_id" name="inferred_selected_top_level_ma_id" />
					<field column="name" name="inferred_selected_top_level_ma_term" /> 								
				</entity>						      											
			</entity>
			
			<!-- MGI genes annotated to this MP term which has pipeline/procedure and allele/strain infos -->
			<!--  p_value 0.0001 is applied for filtering -->
			<entity dataSource="komp2db" name="phenotype_call_summary2"
				query="select distinct gf_acc, procedure_id, parameter_id, pipeline_id, allele_acc, strain_acc, p_value from phenotype_call_summary where mp_acc='${mp_term_infos.term_id}' and p_value &lt;= 0.0001 and gf_db_id=3 and gf_acc like 'MGI:%' and allele_acc is not null and strain_acc is not null">											
				
				<field column="gf_acc" name="mgi_accession_id" />				
				
				<!-- disease associated with this MP via this gene -->	
				<entity dataSource="allele_core" name="doc" stream="true" url="q=mgi_accession_id:&quot;${phenotype_call_summary2.gf_acc}&quot;&amp;rows=1&amp;wt=normal"
					processor="XPathEntityProcessor" forEach="/response/result/doc/" >
					
				    <field column="type" xpath="/response/result/doc/str[@name='type']" /> 				
				    <field column="disease_source" xpath="/response/result/doc/arr[@name='disease_source']/str" /> 
				    <field column="disease_term" xpath="/response/result/doc/str[@name='disease_term']" /> 
				    <field column="disease_alts" xpath="/response/result/doc/arr[@name='disease_alts']/str" /> 
				    <field column="disease_classes" xpath="/response/result/doc/arr[@name='disease_classes']/str" /> 
				    <field column="human_curated" xpath="/response/result/doc/bool[@name='human_curated']" /> 
				    <field column="mouse_curated" xpath="/response/result/doc/bool[@name='mouse_curated']" /> 
				    <field column="mgi_predicted" xpath="/response/result/doc/bool[@name='mgi_predicted']" /> 
				    <field column="impc_predicted" xpath="/response/result/doc/bool[@name='impc_predicted']" /> 
				    <field column="mgi_predicted_in_locus" xpath="/response/result/doc/bool[@name='mgi_predicted_in_locus']" /> 
				    <field column="impc_predicted_in_locus" xpath="/response/result/doc/bool[@name='impc_predicted_in_locus']" /> 			
					<field column="disease_human_phenotypes" xpath="/response/result/doc/arr[@name='phenotypes']/str" />  					

					<!-- other gene related fields -->						
					<field column="marker_symbol" xpath="/response/result/doc/str[@name='marker_symbol']" />                                                        
                    <field column="marker_name" xpath="/response/result/doc/str[@name='marker_name']" />
                    <field column="marker_synonym" xpath="/response/result/doc/arr[@name='marker_synonym']/str" />
                    <field column="marker_type" xpath="/response/result/doc/str[@name='marker_type']" />                                     
                    <field column="human_gene_symbol" xpath="/response/result/doc/arr[@name='human_gene_symbol']/str" />
                             
                    <!-- latest project status (ES cells/mice production status) -->         
                    <field column="status" xpath="/response/result/doc/str[@name='status']" />
                    
                    <!-- phenotyping status -->
					<field column="latest_phenotype_status" xpath="/response/result/doc/str[@name='latest_phenotype_status']" />
                    
                    <!-- latest mice phenotyping status for faceting -->
                    <field column="imits_phenotype_started" xpath="/response/result/doc/str[@name='imits_phenotype_started']" />        
                    <field column="imits_phenotype_complete" xpath="/response/result/doc/str[@name='imits_phenotype_complete']" />
                  	<field column="imits_phenotype_status" xpath="/response/result/doc/str[@name='imits_phenotype_status']" />
                  
                  	<!-- production/phenotyping centers -->
					<field column="latest_production_centre" xpath="/response/result/doc/arr[@name='latest_production_centre']/str" />
					<field column="latest_phenotyping_centre" xpath="/response/result/doc/arr[@name='latest_phenotyping_centre']/str" />
						
					<!-- alleles of a gene -->
					<field column="allele_name" xpath="/response/result/doc/arr[@name='allele_name']/str" />	
				</entity>
				
			</entity>
			

			<!-- pipeline/procedure and allele/strain annotated to this MP term -->
			<!--  no p_value applied here: only for gene -->
			<entity dataSource="komp2db" name="phenotype_call_summary"
				query="select distinct gf_acc, procedure_id, parameter_id, pipeline_id, allele_acc, strain_acc from phenotype_call_summary where mp_acc='${mp_term_infos.term_id}' and gf_db_id=3 and gf_acc like 'MGI:%' and allele_acc is not null and strain_acc is not null">											
						
				<!-- allele: currently NOT restricted to MGI alleles, ie, allele_db_id not restricted to 3 -->
				<!-- index will be problematic if phenotype_call_summary.allele_acc and phenotype_call_summary.gf_acc do not have an entry in komp2.allele table -->
				<entity dataSource="komp2db" name="allele"
					query="select distinct symbol, acc from allele where acc='${phenotype_call_summary.allele_acc}' and gf_acc='${phenotype_call_summary.gf_acc}'">
					<field column="symbol" name="allele_symbol" />
					<field column="acc" name="allele_id" />
				</entity>

				<!-- strain -->
				<entity dataSource="komp2db" name="strain"
					query="select distinct name, acc from strain where acc='${phenotype_call_summary.strain_acc}' and db_id=3">
					<field column="name" name="strain_name" />
					<field column="acc" name="strain_id" />
				</entity>

				<!-- pipeline -->
				<entity dataSource="komp2db" name="phenotype_pipeline"
					query="select distinct stable_id, name, stable_key from phenotype_pipeline where id=${phenotype_call_summary.pipeline_id}">
					<field column="stable_id" name="pipeline_stable_id" />
					<field column="name" name="pipeline_name" />
					<field column="stable_key" name="pipeline_stable_key" />
				</entity>

				<!-- procedure of pipeline -->
				<entity dataSource="komp2db" name="phenotype_procedure"
					query="select distinct name, stable_id, stable_key from phenotype_procedure where id = ${phenotype_call_summary.procedure_id}">
					<field column="name" name="procedure_name" />
					<field column="stable_id" name="procedure_stable_id" />
					<field column="stable_key" name="procedure_stable_key" />
				</entity>

				<!-- parameter of pipeline -->
				<entity dataSource="komp2db" name="phenotype_parameter"
					query="select distinct name, stable_id, stable_key from phenotype_parameter where id=${phenotype_call_summary.parameter_id}">
					<field column="name" name="parameter_name" />
					<field column="stable_id" name="parameter_stable_id" />
					<field column="stable_key" name="parameter_stable_key" />
				</entity>
			</entity>
		</entity>
	</document>

</dataConfig>
