<dataConfig>

	<script>
	<![CDATA[
		function getData(row) {
			if (row.get('observation_type') == 'unidimensional') {
				row.put('data_point', row.get('unidimensional_data_point'));

			} else if (row.get('observation_type') == 'time_series') {
				row.put('data_point', row.get('time_series_data_point'));

			} else if (row.get('observation_type') == 'multidimensional') {
				row.put('data_point', row.get('multidimensional_data_point'));

			}

			return row;
		}

	]]>
	</script>

	<dataSource name="komp2ds" jndiName="java:comp/env/jdbc/komp2DataSource"
		batchSize="-1" readOnly="true" />


	<document name="komp2_indexing">

		<!-- For all observations (data points) -->
		<entity dataSource="komp2ds" transformer="script:getData,RegexTransformer" name="observation"
			query="
			SELECT o.biological_sample_id as bsid, o.parameter_id, e.date_of_experiment, e.external_id, e.id as experiment_id, e.metadata_combined as metadata_combined, e.metadata_group as metadata_group, o.*, co.category as category, uo.data_point as unidimensional_data_point, mo.data_point as multidimensional_data_point, mo.order_index, mo.dimension, tso.data_point as time_series_data_point, tso.time_point, tso.discrete_point
			FROM observation o
			LEFT OUTER JOIN categorical_observation co ON o.id=co.id
			LEFT OUTER JOIN unidimensional_observation uo ON o.id=uo.id
			LEFT OUTER JOIN multidimensional_observation mo ON o.id=mo.id
			LEFT OUTER JOIN time_series_observation tso ON o.id=tso.id
			INNER JOIN experiment_observation eo ON eo.observation_id=o.id
			INNER JOIN experiment e on eo.experiment_id=e.id
			WHERE o.missing = 0
			">

			<field column="id" name="id" />
			<field column="observation_type" name="observation_type" />

			<entity name="biologicalData" processor="CachedSqlEntityProcessor"
				query="SELECT bs.id, strain.strain_acc, bma.allele_acc as allele_accession, a.symbol as allele_symbol, bs.organisation_id, org.name, bs.sample_group, gf.acc as acc, ls.sex as sex, ls.colony_id, ls.zygosity, gf.symbol as symbol, bms.biological_model_id as bmid, ls.date_of_birth as birthdate, ls.colony_id, bs.external_id as external_sample_id
				FROM biological_sample bs
				INNER JOIN organisation org ON bs.organisation_id=org.id
				INNER JOIN live_sample ls ON bs.id=ls.id
				INNER JOIN biological_model_sample bms ON bs.id=bms.biological_sample_id
				INNER JOIN biological_model_strain strain ON strain.biological_model_id=bms.biological_model_id
				LEFT OUTER JOIN biological_model_genomic_feature bmgf ON bmgf.biological_model_id=bms.biological_model_id
				LEFT OUTER JOIN biological_model_allele bma ON bma.biological_model_id=bms.biological_model_id
				LEFT OUTER JOIN allele a ON (a.acc=bma.allele_acc AND a.db_id=bma.allele_db_id)
				LEFT OUTER JOIN genomic_feature gf ON gf.acc=bmgf.gf_acc"
				where="id=observation.bsid">

				<field column="bmid" name="biological_model_id" />
				<field column="biological_sample_id" name="biological_sample_id" />
				<field column="acc" name="gene_accession" />
				<field column="allele_accession" name="allele_accession" />
				<field column="allele_symbol" name="allele_symbol" />
				<field column="symbol" name="gene_symbol" />
				<field column="strain_acc" name="strain" />
				<field column="organisation_id" name="phenotyping_center_id" />
				<field column="name" name="phenotyping_center" />
				<field column="zygosity" name="zygosity" />
				<field column="birthdate" name="date_of_birth" />
				<field column="sex" name="sex" />
				<field column="colony_id" name="colony_id" />
				<field column="sample_group" name="biological_sample_group" />
	
			</entity>

			<entity name="procedureData" processor="CachedSqlEntityProcessor"
				query="SELECT param.id, pipe.name as pipeline_name, pipe.id as pipeline_id, pipe.stable_id as pipeline_stable_id, param.name as parameter_name, proc.name as procedure_name, proc.id as procedure_id, proc.stable_id as procedure_stable_id, param.stable_id as parameter_stable_id
					FROM phenotype_parameter param
					INNER JOIN phenotype_procedure_parameter procparam ON procparam.parameter_id=param.id
					INNER JOIN phenotype_procedure proc ON proc.id=procparam.procedure_id
					INNER JOIN phenotype_pipeline_procedure pipeproc ON pipeproc.procedure_id=proc.id
					INNER JOIN phenotype_pipeline pipe ON pipe.id=pipeproc.pipeline_id"
					where="id=observation.parameter_id">

				<field column="pipeline_name" name="pipeline_name" />
				<field column="pipeline_id" name="pipeline_id" />
				<field column="pipeline_stable_id" name="pipeline_stable_id" />
				<field column="procedure_id" name="procedure_id" />
				<field column="procedure_name" name="procedure_name" />
				<field column="procedure_stable_id" name="procedure_stable_id" />
				<field column="parameter_id" name="parameter_id" />
				<field column="parameter_name" name="parameter_name" />
				<field column="parameter_stable_id" name="parameter_stable_id" />
	
			</entity>

			<field column="external_sample_id" name="external_sample_id" />

			<field column="category" name="category" />
			<field column="data_point" name="data_point" />
			<field column="order_index" name="order_index" />
			<field column="dimension" name="dimension" />
			<field column="time_point" name="time_point" />
			<field column="discrete_point" name="discrete_point" />

			<field column="experiment_id" name="experiment_id" />
			<field column="external_id" name="experiment_source_id" />
			<field column="date_of_experiment" name="date_of_experiment" />


			<!-- metadata and calculate metadata group -->
			<field column="metadata_group" name="metadata_group" />
			<field column="metadata" sourceColName="metadata_combined" splitBy="::" />

			<!-- NOTE ** ALERT ** NOTE ** ALERT ** CAUTION 
				
				The outer entity will short circuit executing 
				the inner entity when observation.id is not defined, 
				otherwise it will execute the inner entity.
				
				Essentially, this will only run the query when the 
				observation is an image_record_observation.

			CAUTION ** ALERT ** NOTE ** ALERT ** NOTE -->

			<entity name="protect" processor="CachedSqlEntityProcessor"
				query="SELECT 1 FROM (SELECT 1) a where '${observation.observation_type}' = 'image_record'" >
				<entity dataSource="komp2ds" name="imageRecord" onError="skip" 
					query="SELECT iro.file_type, iro.full_resolution_file_path, iro.large_thumbnail_file_path, iro.small_thumbnail_file_path
                       FROM image_record_observation iro
                       WHERE iro.id=${observation.id}
						">
					<field column="full_resolution_file_path" name="full_resolution_file_path" />
					<field column="large_thumbnail_file_path" name="large_thumbnail_file_path" />
					<field column="small_thumbnail_file_path" name="small_thumbnail_file_path" />
					<field column="file_type" name="file_type" />
				</entity>
			</entity>
 
		</entity>

	</document>

</dataConfig>
