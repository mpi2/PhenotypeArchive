<dataConfig>

	<script>
	<![CDATA[
		function getData(row) {
			if (row.get('observation_type') == 'categorical') {
				row.put('category', row.get('category'));

			} else if (row.get('observation_type') == 'unidimensional') {
				row.put('data_point', row.get('unidimensional_data_point'));

			} else if (row.get('observation_type') == 'multidimensional') {
				row.put('data_point', row.get('multidimensional_data_point'));
				row.put('order_index', row.get('order_index'));
				row.put('dimension', row.get('dimension'));

			} else if (row.get('observation_type') == 'time_series') {
				row.put('data_point', row.get('time_series_data_point'));
				row.put('time_point', row.get('time_point'));
				row.put('discrete_point', row.get('discrete_point'));

			} else if (row.get('observation_type') == 'metadata') {
				row.put('value', row.get('value'));

			}
			
			return row;
		}

		// Add metadata to the document
		function getMetadata(row) {

			var combined = row.get('metadata_combined');

			if(typeof combined != 'undefined' && combined != null) {

				var pieces = combined.split('::');
				var arr = new java.util.ArrayList();

				for (var i=0; i<pieces.length; i++) {
					arr.add(pieces[i]);
				}

				row.put('metadata', arr);

			} else {
			
				// Override the metadata group to be empty,
				// because there is no metadata to associate
				row.put('metadata_group', '');

			}
			
			return row;
		}

	]]>
	</script>

	<dataSource name="komp2ds" jndiName="java:comp/env/jdbc/komp2DataSource" batchSize="-1" readOnly="true" />


	<document name="komp2_indexing">

		<!-- For all observations (data points) -->
		<entity dataSource="komp2ds" transformer="script:getData" name="observation" onError="skip" query="
			SELECT strain.strain_acc, pipe.name as pipeline_name, pipe.id as pipeline_id, pipe.stable_id as pipeline_stable_id, param.name as parameter_name, proc.name as procedure_name, proc.id as procedure_id, proc.stable_id as procedure_stable_id, param.stable_id as parameter_stable_id,bs.organisation_id, org.name, bs.sample_group, gf.acc as acc, ls.sex as sex, ls.colony_id, ls.zygosity, gf.symbol as symbol, bms.biological_model_id as bmid, ls.date_of_birth as birthdate, ls.colony_id, e.date_of_experiment, e.external_id, e.id as experiment_id, o.*, co.category as category, uo.data_point as unidimensional_data_point, mo.data_point as multidimensional_data_point, mo.order_index, mo.dimension, tso.data_point as time_series_data_point, tso.time_point, tso.discrete_point, iro.file_type, iro.full_resolution_file_path, iro.small_thumbnail_file_path, bs.external_id as external_sample_id
			FROM observation o
			LEFT OUTER JOIN categorical_observation co ON o.id=co.id
			LEFT OUTER JOIN unidimensional_observation uo ON o.id=uo.id
			LEFT OUTER JOIN multidimensional_observation mo ON o.id=mo.id
			LEFT OUTER JOIN time_series_observation tso ON o.id=tso.id
			LEFT OUTER JOIN image_record_observation iro ON o.id=iro.id
			INNER JOIN biological_sample bs ON bs.id=o.biological_sample_id
			INNER JOIN organisation org ON bs.organisation_id=org.id
			INNER JOIN live_sample ls ON bs.id=ls.id
			INNER JOIN biological_model_sample bms ON bs.id=bms.biological_sample_id
			INNER JOIN biological_model_strain strain ON strain.biological_model_id=bms.biological_model_id
			LEFT OUTER JOIN biological_model_genomic_feature bmgf ON bmgf.biological_model_id=bms.biological_model_id
			LEFT OUTER JOIN genomic_feature gf ON gf.acc=bmgf.gf_acc
			INNER JOIN phenotype_parameter param ON param.id=o.parameter_id
			INNER JOIN phenotype_procedure_parameter procparam ON procparam.parameter_id=param.id
			INNER JOIN phenotype_procedure proc ON proc.id=procparam.procedure_id
			INNER JOIN phenotype_pipeline_procedure pipeproc ON pipeproc.procedure_id=proc.id
			INNER JOIN phenotype_pipeline pipe ON pipe.id=pipeproc.pipeline_id
			INNER JOIN experiment_observation eo ON eo.observation_id=o.id
			INNER JOIN experiment e on eo.experiment_id=e.id
			WHERE o.missing = 0
			">

			<field column="id" name="id" />
			<field column="observation_type" name ="observation_type" />
			<field column="bmid" name="biological_model_id" />
			<field column="biological_sample_id" name ="biological_sample_id" />
			<field column="sample_group" name="biological_sample_group" />
			<field column="external_sample_id" name ="external_sample_id" />

			<field column="value" name ="value" />
			<field column="category" name ="category" />
			<field column="data_point" name ="data_point" />
			<field column="order_index" name ="order_index" />
			<field column="dimension" name ="dimension" />
			<field column="time_point" name ="time_point" />
			<field column="discrete_point" name ="discrete_point" />
			<field column="full_resolution_file_path" name ="full_resolution_file_path" />
			<field column="large_thumbnail_file_path" name ="large_thumbnail_file_path" />
			<field column="small_thumbnail_file_path" name ="small_thumbnail_file_path" />

			<field column="acc" name="gene_accession" />
			<field column="symbol" name="gene_symbol" />
			<field column="zygosity" name="zygosity" />
			<field column="birthdate" name="date_of_birth" />
			<field column="sex" name="sex" />
			<field column="colony_id" name="colony_id" />
			<field column="strain_acc" name="strain" />

			<!-- field column="organisation_id" name ="organisation_id" /-->
			<!-- field column="name" name ="organisation" /-->
			<field column="organisation_id" name="phenotyping_center_id" />
			<field column="name" name="phenotyping_center" />

			<field column="pipeline_name" name ="pipeline_name" />
			<field column="pipeline_id" name ="pipeline_id" />
			<field column="pipeline_stable_id" name ="pipeline_stable_id" />

			<field column="procedure_id" name ="procedure_id" />
			<field column="procedure_name" name ="procedure_name" />
			<field column="procedure_stable_id" name ="procedure_stable_id" />

			<field column="parameter_id" name ="parameter_id" />
			<field column="parameter_name" name ="parameter_name" />
			<field column="parameter_stable_id" name ="parameter_stable_id" />

			<field column="experiment_id" name ="experiment_id" />
			<field column="external_id" name ="experiment_source_id" />
			<field column="date_of_experiment" name ="date_of_experiment" />
			
			<!-- <entity name="e" transformer="TemplateTransformer">
				<field column="metadata_group"  template="" />
			</entity> -->
			<!--  metadata and calculate metadata group -->
			<entity dataSource="komp2ds" transformer="script:getMetadata" name="procedureMetaDataGroup" onError="skip"
				query="SELECT 
					    (SELECT GROUP_CONCAT(DISTINCT CONCAT(pp.name, ' = ', pmdin.value) ORDER BY pmdin.parameter_id ASC SEPARATOR '::')
					        FROM procedure_meta_data pmdin
					        INNER JOIN phenotype_parameter pp ON pp.stable_id=pmdin.parameter_id 
					        WHERE e.id=pmdin.experiment_id) as metadata_combined,
					    (SELECT MD5(GROUP_CONCAT(DISTINCT CONCAT(pp.name, ' = ', pmdin.value) ORDER BY pmdin.parameter_id ASC SEPARATOR '::'))
					        FROM procedure_meta_data pmdin
					        INNER JOIN phenotype_parameter pp ON pp.stable_id=pmdin.parameter_id 
					        WHERE pp.data_analysis=1 AND pmdin.experiment_id=e.id) as metadata_group
					FROM experiment e WHERE e.id=${observation.experiment_id}
					">
				<field column="metadata" name="metadata" />
				<field column="metadata_group" name ="metadata_group" />
			</entity>

		</entity>

	</document>

</dataConfig>
